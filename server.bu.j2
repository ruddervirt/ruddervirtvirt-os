# SPDX-License-Identifier: GPL-3.0-only
variant: fcos
version: 1.6.0
passwd:
  users:
    - name: admin
      groups: ["wheel", "sudo"]
      {% if password_hash %}
      password_hash: "{{ password_hash }}"
      {% endif %}
      {% if ssh_keys %}
      ssh_authorized_keys:
        {%- for key in ssh_keys %}
        - "{{ key }}"
        {%- endfor %}
      {% endif %}
    - name: rudderadmin
      groups: ["wheel", "sudo"]
systemd:
  units:
    - name: "rpm-ostree-install-packages.service"
      enabled: true
      contents: |
        [Unit]
        Description=Install packages
        Wants=network-online.target
        After=network-online.target
        Before=zincati.service
        ConditionPathExists=|!/usr/share/selinux/packages/k3s.pp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=rpm-ostree install --apply-live --allow-inactive --assumeyes k3s-selinux btop mdadm iperf3 /var/tmp/k9s.rpm
        ExecStartPost=bash -c "rm -f /var/tmp/k9s.rpm"

        [Install]
        WantedBy=multi-user.target
    - name: "rudderadmin-key-sync-setup.service"
      enabled: true
      contents: |
        [Unit]
        Description=rudderadmin Key Sync Setup
        Wants=systemd-remount-fs.service local-fs.target network-online.target
        After=systemd-remount-fs.service local-fs.target network-online.target
        ConditionPathExists=!/var/.rudderadmin-key-sync-installed

        [Service]
        Type=oneshot
        ExecStartPre=/bin/bash -c 'curl -Lo /var/opt/ssh-key-sync_linux_amd64.tar.gz https://github.com/shoenig/ssh-key-sync/releases/download/v1.7.3/ssh-key-sync_1.7.3_linux_amd64.tar.gz'    
        ExecStartPre=/bin/bash -c 'tar -xzf /var/opt/ssh-key-sync_linux_amd64.tar.gz -C /usr/local/bin/ ssh-key-sync'
        ExecStartPre=/bin/bash -c 'touch /var/.rudderadmin-key-sync-installed'
        ExecStart=/bin/bash -c 'exit 0'

        [Install]
        WantedBy=multi-user.target
    - name: "rudderadmin-key-sync.service"
      enabled: true
      contents: |
        [Unit]
        Description=Synchronize ssh authorized keys for rudderadmin
        Wants=network-online.target rudderadmin-key-sync-setup.service
        After=network-online.target rudderadmin-key-sync-setup.service

        [Service]
        User=rudderadmin
        ExecStartPre=-/bin/mkdir -p /home/rudderadmin/.ssh
        ExecStartPre=-/bin/touch /home/rudderadmin/.ssh/authorized_keys
        ExecStart=/usr/local/bin/ssh-key-sync -verbose -system-user rudderadmin -github-user rudder-virt

        [Install]
        WantedBy=multi-user.target
    - name: "rudderadmin-key-sync.timer"
      enabled: true
      contents: |
        [Unit]
        Description=Synchronize ssh authorized keys for rudderadmin

        [Timer]
        OnBootSec=5min
        OnUnitActiveSec=24h
        Persistent=true
        Unit=rudderadmin-key-sync.service

        [Install]
        WantedBy=timers.target
    - name: "install-etcdctl.service"
      enabled: true
      contents: |
        [Unit]
        Description=Install etcdctl binary
        ConditionPathExists=!/opt/bin/etcdctl
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        Environment=ETCD_VERSION=v3.5.21
        ExecStartPre=/usr/bin/mkdir -p /opt/bin
        ExecStart=/bin/bash -c '\
          curl -fsSL https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz \
          | tar xz --strip-components=1 -C /opt/bin etcd-${ETCD_VERSION}-linux-amd64/etcdctl'
        ExecStartPost=/usr/bin/chmod +x /opt/bin/etcdctl

        [Install]
        WantedBy=multi-user.target
    - name: "purge-k3s.service"
      enabled: false
      contents: |
        [Unit]
        Description=Purge K3s THIS WILL DELETE ALL K3S DATA; USE WITH CAUTION
        Wants=network-online.target
        After=network-online.target

        [Service]
        Type=oneshot
        ExecStartPre=-/bin/bash -c 'rm -rf /var/lib/rancher/k3s'
        ExecStartPre=-/bin/bash -c 'rm -rf /etc/rancher/k3s'
        ExecStart=/bin/true

        [Install]
        WantedBy=multi-user.target
    - name: "k3s.service"
      enabled: true
      contents: |
        [Unit]
        Description=Run K3s
        Wants=network-online.target rpm-ostree-install-packages.service
        After=network-online.target rpm-ostree-install-packages.service

        [Service]
        Type=notify
        EnvironmentFile=-/etc/default/%N
        EnvironmentFile=-/etc/sysconfig/%N
        EnvironmentFile=-/etc/systemd/system/%N.env
        KillMode=process
        Delegate=yes
        LimitNOFILE=1048576
        LimitNPROC=infinity
        LimitCORE=infinity
        TasksMax=infinity
        TimeoutStartSec=0
        Restart=always
        RestartSec=5s
        ExecStartPre=/bin/mkdir -p /etc/rancher/k3s
        ExecStartPre=/bin/ln -sf /etc/ruddervirt/k3s-config.yaml /etc/rancher/k3s/config.yaml
        ExecStartPre=-/sbin/modprobe br_netfilter
        ExecStartPre=-/sbin/modprobe overlay
        ExecStartPre=-/sbin/modprobe iscsi_tcp
        ExecStartPre=-/sbin/modprobe dm_crypt
        ExecStartPre=-/sbin/modprobe nfs
        ExecStartPre=-/sbin/modprobe wireguard
        ExecStartPre=-/sbin/modprobe tun
        ExecStartPre=-/sbin/modprobe geneve
        ExecStartPre=-/sbin/modprobe openvswitch
        ExecStartPre=-/sbin/modprobe ip_tables
        ExecStartPre=-/sbin/modprobe iptable_nat
        ExecStart=/bin/bash -c '/usr/local/bin/k3s server'
        #ExecStart=/bin/bash -c '/usr/local/bin/k3s agent'
        [Install]
        WantedBy=multi-user.target
storage:
  disks:
    - device: {{ disk_path }}
      wipe_table: false
      partitions:
        - number: 4
          resize: true
          size_mib: 51200 # root at 50GB
        - number: 5
          size_mib: 0
  files:
    - path: /etc/modprobe.d/ixgbe.conf
      mode: 0644
      contents:
        inline: |
          options ixgbe allow_unsupported_sfp=1
    - path: /etc/yum.repos.d/rancher-k3s-common.repo
      mode: 0644
      contents:
        inline: |
          [rancher-k3s-common-stable]
          name=Rancher K3s Common (stable)
          baseurl=https://rpm.rancher.io/k3s/stable/common/centos/8/noarch
          enabled=1
          gpgcheck=1
          repo_gpgcheck=0
          gpgkey=https://rpm.rancher.io/public.key
    {% for name in manifest_files("manifests") %}
    - path: /var/lib/rancher/k3s/server/manifests/{{ name }}
      overwrite: true
      mode: 0644
      contents:
        inline: |
          {{ slurp("manifests/" ~ name) | indent(10) }}
    {% endfor %}
    - path: /var/lib/rancher/k3s/server/manifests/kubevirt-crd.yaml
      overwrite: true
      mode: 0644
      contents:
        source: "https://github.com/kubevirt/kubevirt/releases/download/v1.4.0/kubevirt-cr.yaml"
    - path: /var/lib/rancher/k3s/server/manifests/kubevirt-operator.yaml
      overwrite: true
      mode: 0644
      contents:
        source:  https://github.com/kubevirt/kubevirt/releases/download/v1.4.0/kubevirt-operator.yaml
    - path: /var/lib/rancher/k3s/server/manifests/cdi-crd.yaml
      overwrite: true
      mode: 0644
      contents:
        source: https://github.com/kubevirt/containerized-data-importer/releases/download/v1.62.0/cdi-cr.yaml
    - path: /var/lib/rancher/k3s/server/manifests/cdi-operator.yaml
      overwrite: true
      mode: 0644
      contents:
        source: https://github.com/kubevirt/containerized-data-importer/releases/download/v1.62.0/cdi-operator.yaml
    - path: /etc/NetworkManager/conf.d/no-search-domains.conf
      mode: 0644
      contents:
        inline: |
          [main]
          dns=none
          rc-manager=unmanaged
    - path: /usr/local/bin/k3s
      overwrite: true
      mode: 0755
      contents:
        source: "https://github.com/k3s-io/k3s/releases/download/v1.33.6%2Bk3s1/k3s"
    - path: /var/tmp/k9s.rpm 
      overwrite: true
      mode: 0755
      contents:
        source: "https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_linux_amd64.rpm"
    - path: /etc/kubelet.config
      mode: 0644
      contents:
        inline: |
          apiVersion: kubelet.config.k8s.io/v1beta1
          kind: KubeletConfiguration
          shutdownGracePeriod: 60s
          shutdownGracePeriodCriticalPods: 10s
    - path: /usr/local/bin/ssh-key-sync
      mode: 0777
      contents:
        inline: |
          # placeholder
    - path: /opt/bin/setup-private-network
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env bash
          set -euo pipefail

          read -r -p "Interface name (e.g. eno1): " IFNAME
          read -r -p "IPv4 address (e.g. 192.168.10.2): " IPADDR

          if [[ -z "${IFNAME}" || -z "${IPADDR}" ]]; then
            echo "Interface name and IP address are required." >&2
            exit 1
          fi

          if ! ip link show "${IFNAME}" >/dev/null 2>&1; then
            echo "Interface '${IFNAME}' does not exist." >&2
            exit 1
          fi

          if nmcli -t -f NAME connection show | grep -Fxq "${IFNAME}"; then
            echo "A NetworkManager connection named '${IFNAME}' already exists." >&2
            exit 1
          fi

          echo ""
          echo "About to configure interface:"
          echo "  IFNAME: ${IFNAME}"
          echo "  IPADDR: ${IPADDR}/24"
          echo "  MTU: 9000"
          read -r -p "Proceed? [y/N]: " CONFIRM

          case "${CONFIRM}" in
            y|Y|yes|YES)
              sudo nmcli connection add type ethernet con-name "${IFNAME}" ifname "${IFNAME}" ipv4.method manual ipv4.addresses "${IPADDR}/24"
              sudo nmcli connection modify "${IFNAME}" 802-3-ethernet.mtu 9000
              sudo nmcli connection up "${IFNAME}"
              ;;
            *)
              echo "Aborted."
              exit 0
              ;;
          esac
    - path: /usr/local/bin/kubectl
      mode: 0777
      contents:
        inline: |
          #!/bin/sh
          exec k3s kubectl "$@"
    - path: /etc/profile.d/01-custom-profile.sh
      mode: 0777
      contents:
        inline: |
          alias vim="vi"
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    {% set _zincati_disable_prefix = "99" if disable_autoupdate else "50" %}
    {% set _zincati_periodic_prefix = "50" if disable_autoupdate else "99" %}
    - path: /etc/zincati/config.d/{{ _zincati_periodic_prefix }}-periodic-sat-midnight-us-eastern.toml
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [updates]
          enabled = true
          strategy = "periodic"

          [updates.periodic]
          time_zone = "US/Eastern"

          [[updates.periodic.window]]
          days = [ "Sat" ]
          start_time = "00:00"
          length_minutes = 60
    - path: /etc/ruddervirt/k3s-config.yaml
      mode: 0644
      overwrite: true
      contents:
        inline: |
          # connecting to another server
          #server: https://192.168.103.2:6443
          #token: MYTOKEN
          
          # initialize the cluster; only on first server
          #cluster-init: true
          # backup the cluster
          #etcd-s3: true
          #etcd-s3-config-secret: k3s-etcd-snapshot-s3-config
          
          # this requires the local ip address
          bind-address: 192.168.103.1
          advertise-address: 192.168.103.1
          node-ip: 192.168.103.1
          tls-san:
            - "192.168.103.1"
          
          # cluster networking settings; only matters when tailscale operator exists
          cluster-cidr: 10.32.0.0/16
          service-cidr: 10.33.0.0/16
          cluster-dns: 10.33.0.10

          # generic settings; shouldn't ever change
          kubelet-arg:
            - "config=/etc/kubelet.config"
          node-label:
            - "ruddervirt=metal"
          resolv-conf: /etc/resolv.conf
          disable: 
            - "local-storage"
    - path: /etc/zincati/config.d/{{ _zincati_disable_prefix }}-disable-updates.toml
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [updates]
          enabled = false
    - path: /etc/resolv.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          nameserver 1.1.1.1
          nameserver 8.8.8.8
    - path: /etc/sysctl.d/98-inotify.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          fs.inotify.max_user_instances=8192
          fs.inotify.max_user_watches=524288
    - path: /etc/sysctl.d/99-nebula.conf
      mode: 0644
      contents:
        inline: |
          net.ipv4.ip_forward=1
          net.ipv6.conf.all.forwarding=1
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          ruddervirtvirtos-default